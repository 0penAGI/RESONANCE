<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RIFT: Colony Builder</title>
<style>
:root {
    --bg-color: #0f172a;
    --panel-bg: #1e293b;
    --accent-primary: #06b6d4;
    --accent-secondary: #d946ef;
    --success: #22c55e;
    --danger: #ef4444;
    --warning: #fbbf24;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --grid-line: #334155;
    --cell-size: clamp(30px, 9vmin, 60px);
}
* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
body {
    margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main);
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    overflow: hidden; height: 100vh; display: flex; flex-direction: column;
}
header {
    background: var(--panel-bg); padding: 10px 15px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); z-index: 10;
    border-bottom: 1px solid var(--grid-line);
}
.header-top {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
}
h1 {
    margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: 1px;
    background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-transform: uppercase;
}
.stats-bar {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
.stat-item {
    display: flex; flex-direction: column; align-items: center;
    background: rgba(0,0,0,0.2); padding: 6px; border-radius: 6px; font-size: 0.8rem;
}
.stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
.stat-value { font-weight: bold; font-family: 'Courier New', monospace; }

main {
    flex: 1; display: flex; justify-content: center; align-items: center;
    overflow: auto; position: relative;
    background-image: radial-gradient(var(--grid-line) 1px, transparent 1px);
    background-size: 20px 20px;
}
.city-grid {
    display: grid;
    grid-template-columns: repeat(8, var(--cell-size));
    grid-template-rows: repeat(8, var(--cell-size));
    gap: 2px; padding: 10px;
    background: rgba(0,0,0,0.5); border: 1px solid var(--grid-line); border-radius: 8px;
}
.cell {
    background-color: var(--panel-bg); border: 1px solid var(--grid-line);
    border-radius: 4px; display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    font-size: calc(var(--cell-size) * 0.6); cursor: pointer;
    position: relative; transition: all 0.2s ease;
}
.cell:hover { border-color: var(--text-muted); transform: scale(1.05); z-index: 2; }
.cell .icon { font-size: calc(var(--cell-size) * 0.7); margin-bottom: 2px; }
.cell .info { font-size: calc(var(--cell-size) * 0.25); color: var(--text-muted); }

.building-residential { color: #60a5fa; text-shadow: 0 0 8px #60a5fa; }
.building-industrial { color: #f87171; text-shadow: 0 0 8px #f87171; }
.building-commercial { color: #fbbf24; text-shadow: 0 0 8px #fbbf24; }
.building-park { color: #4ade80; text-shadow: 0 0 8px #4ade80; }

.controls {
    background: var(--panel-bg); border-top: 1px solid var(--grid-line);
    padding: 10px; z-index: 20;
}
.tools-scroll {
    display: flex; gap: 12px; overflow-x: auto; padding: 5px 0;
    scrollbar-width: none;
}
.tools-scroll::-webkit-scrollbar { display: none; }
.tool-btn {
    background: rgba(255,255,255,0.05); border: 1px solid var(--grid-line);
    border-radius: 10px; padding: 10px 14px; min-width: 90px;
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; transition: all 0.2s; color: var(--text-muted); flex-shrink: 0;
}
.tool-btn.selected {
    background: rgba(6, 182, 212, 0.25); border-color: var(--accent-primary);
    color: var(--accent-primary); transform: translateY(-3px);
}
.tool-icon { font-size: 1.8rem; margin-bottom: 6px; }
.tool-name { font-size: 0.75rem; font-weight: bold; }
.tool-cost { font-size: 0.7rem; color: var(--text-muted); }
.tool-btn.selected .tool-cost { color: var(--accent-primary); }

.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center;
    z-index: 100; backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal {
    background: var(--panel-bg); border: 2px solid var(--accent-primary);
    padding: 30px; border-radius: 16px; max-width: 90%; width: 420px;
    text-align: center; box-shadow: 0 0 30px rgba(6, 182, 212, 0.4);
}
.modal h2 { margin-top: 0; color: var(--accent-primary); font-size: 1.5rem; }
.modal p { color: var(--text-muted); line-height: 1.6; }
.btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border: none; padding: 14px 28px; color: white; font-weight: bold;
    border-radius: 8px; cursor: pointer; margin-top: 20px; width: 100%;
    text-transform: uppercase; letter-spacing: 1.5px; font-size: 1.1rem;
}
.btn-primary:active { transform: scale(0.98); }

.toast-container {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
    display: flex; flex-direction: column; gap: 10px; z-index: 50; pointer-events: none;
}
.toast {
    background: rgba(0,0,0,0.9); border-left: 5px solid var(--accent-primary);
    color: white; padding: 12px 24px; border-radius: 8px; font-size: 1rem;
    animation: slideUp 0.4s ease-out; box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    min-width: 200px; text-align: center;
}
.toast.error { border-left-color: var(--danger); }
@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.floater {
    position: absolute; font-weight: bold; font-size: 0.9rem;
    pointer-events: none; animation: floatUp 1.2s forwards; z-index: 10;
}
@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-40px); opacity: 0; }
}
</style>
</head>
<body>

<!-- Welcome Modal -->
<div id="startModal" class="modal-overlay open">
    <div class="modal">
        <h2>Welcome to RIFT</h2>
        <p>Build a thriving colony in the dimensional void.</p>
        <p><strong>üè† Hab-Dome</strong> ‚Üí Population<br>
           <strong>‚ö° Reactor</strong> ‚Üí Energy<br>
           <strong>üè¢ Trade Hub</strong> ‚Üí Income (needs pop & energy)<br>
           <strong>üå≥ Bio-Dome</strong> ‚Üí Happiness ‚Üí Faster pop growth</p>
        <p style="color: var(--danger)">‚ö†Ô∏è Don't let Credits or Energy go negative!</p>
        <button class="btn-primary" onclick="startGame()">Initialize Colony</button>
    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="modal-overlay">
    <div class="modal">
        <h2 id="goTitle" style="color: var(--danger)">COLONY COLLAPSE</h2>
        <p id="goMessage">The rift has consumed your colony.</p>
        <div style="margin: 20px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
            <div>Final Population: <span id="goPop" style="color:#60a5fa; font-weight:bold">0</span></div>
            <div>Cycles Survived: <span id="goCycle" style="color:white; font-weight:bold">0</span></div>
            <div>Happiness: <span id="goHappiness" style="color:#4ade80; font-weight:bold">0%</span></div>
        </div>
        <button class="btn-primary" onclick="resetGame()">Reboot System</button>
    </div>
</div>

<header>
    <div class="header-top">
        <h1>RIFT</h1>
        <div style="font-size: 0.8rem; color: var(--accent-primary)">Cycle: <span id="cycleDisplay">0</span></div>
    </div>
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Credits</span>
            <span class="stat-value" id="moneyDisplay" style="color: #fbbf24">150</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Energy</span>
            <span class="stat-value" id="energyDisplay">20</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Population</span>
            <span class="stat-value" id="popDisplay" style="color: #60a5fa">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Happiness</span>
            <span class="stat-value" id="happyDisplay" style="color: #4ade80">50%</span>
        </div>
    </div>
</header>

<main>
    <div id="grid" class="city-grid"></div>
</main>

<div class="controls">
    <div class="tools-scroll">
        <div class="tool-btn" data-tool="bulldoze" onclick="selectTool('bulldoze')">
            <div class="tool-icon">üöß</div>
            <div class="tool-name">Clear</div>
            <div class="tool-cost">+5 Credits</div>
        </div>
        <div class="tool-btn selected" data-tool="residential" onclick="selectTool('residential')">
            <div class="tool-icon">üè†</div>
            <div class="tool-name">Hab-Dome</div>
            <div class="tool-cost">50 Credits</div>
        </div>
        <div class="tool-btn" data-tool="industrial" onclick="selectTool('industrial')">
            <div class="tool-icon">‚ö°</div>
            <div class="tool-name">Reactor</div>
            <div class="tool-cost">100 Credits</div>
        </div>
        <div class="tool-btn" data-tool="commercial" onclick="selectTool('commercial')">
            <div class="tool-icon">üè¢</div>
            <div class="tool-name">Trade Hub</div>
            <div class="tool-cost">150 Credits</div>
        </div>
        <div class="tool-btn" data-tool="park" onclick="selectTool('park')">
            <div class="tool-icon">üå≥</div>
            <div class="tool-name">Bio-Dome</div>
            <div class="tool-cost">75 Credits</div>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
// Game State
const GRID_SIZE = 8;
const TICK_RATE = 3000;

const BUILDINGS = {
    residential: { name: 'Hab-Dome', icon: 'üè†', cost: 50, energy: -2, popCap: 8, income: 0, happiness: 2 },
    industrial:  { name: 'Reactor', icon: '‚ö°', cost: 100, energy: 15, popCap: 0, income: 0, happiness: -3 },
    commercial:  { name: 'Trade Hub', icon: 'üè¢', cost: 150, energy: -5, popCap: 0, income: 20, happiness: 1 },
    park:        { name: 'Bio-Dome', icon: 'üå≥', cost: 75, energy: -1, popCap: 0, income: 0, happiness: 10 },
};

let state = {
    credits: 150,
    energy: 20,
    population: 0,
    popCapacity: 0,
    happiness: 50, // 0-100%
    cycle: 0,
    grid: [],
    selectedTool: 'residential',
    gameActive: false,
    timer: null
};

const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.ready(); }

function initGrid() {
    const gridEl = document.getElementById('grid');
    gridEl.innerHTML = '';
    state.grid = [];
    for (let y = 0; y < GRID_SIZE; y++) {
        const row = [];
        for (let x = 0; x < GRID_SIZE; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.onclick = () => handleCellClick(x, y, cell);
            gridEl.appendChild(cell);
            row.push(null);
        }
        state.grid.push(row);
    }
}

function startGame() {
    document.getElementById('startModal').classList.remove('open');
    resetState();
    initGrid();
    updateUI();
    state.gameActive = true;
    state.timer = setInterval(gameTick, TICK_RATE);
    showToast("Colony initialized. Begin construction.");
    if (tg) tg.HapticFeedback.impactOccurred('light');
}

function resetState() {
    state = {
        credits: 150,
        energy: 20,
        population: 0,
        popCapacity: 0,
        happiness: 50,
        cycle: 0,
        grid: [],
        selectedTool: 'residential',
        gameActive: false,
        timer: null
    };
}

function resetGame() {
    if (state.timer) clearInterval(state.timer);
    document.getElementById('gameOverModal').classList.remove('open');
    startGame();
}

function selectTool(tool) {
    state.selectedTool = tool;
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.tool === tool);
    });
}

function handleCellClick(x, y, cellEl) {
    if (!state.gameActive) return;

    const current = state.grid[y][x];
    const tool = state.selectedTool;

    if (tool === 'bulldoze') {
        if (current) {
            state.credits += 5; // Fixed +5 as shown on button
            state.grid[y][x] = null;
            cellEl.innerHTML = '';
            cellEl.className = 'cell';
            createFloater(cellEl, '+5 Cr', 'var(--success)');
            updateUI();
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }
        return;
    }

    if (current) {
        showToast("Cell occupied! Use Clear tool.", "error");
        return;
    }

    const b = BUILDINGS[tool];
    if (state.credits >= b.cost) {
        state.credits -= b.cost;
        state.grid[y][x] = tool;

        cellEl.innerHTML = `
            <div class="icon">${b.icon}</div>
            <div class="info">
                ${b.energy !== 0 ? (b.energy > 0 ? '+' : '') + b.energy + '‚ö°' : ''}
                ${b.income > 0 ? '+' + b.income + '‚Ç°' : ''}
            </div>`;
        cellEl.classList.add('building-' + tool);

        createFloater(cellEl, `-${b.cost} Cr`, 'var(--text-muted)');
        calculateStats();
        updateUI();
        if (tg) tg.HapticFeedback.impactOccurred('medium');
    } else {
        showToast("Not enough Credits!", "error");
        shakeUI();
    }
}

function calculateStats() {
    let energyProd = 20; // base
    let energyUse = 0;
    let income = 0;
    let popCap = 0;
    let happyMod = 0;
    let buildingCount = { residential:0, industrial:0, commercial:0, park:0 };

    for (let row of state.grid) {
        for (let type of row) {
            if (type) {
                const b = BUILDINGS[type];
                buildingCount[type]++;
                popCap += b.popCap;
                happyMod += b.happiness;
                income += b.income;
                if (b.energy > 0) energyProd += b.energy;
                else if (b.energy < 0) energyUse += Math.abs(b.energy);
            }
        }
    }

    const totalEnergy = energyProd - energyUse;
    state.popCapacity = popCap;
    state.energy = totalEnergy;

    // Happiness: 0‚Äì100%
    state.happiness = Math.max(0, Math.min(100, 50 + happyMod));

    // Commercial efficiency: needs energy and population
    const energyRatio = totalEnergy > 0 ? 1 : 0;
    const popRatio = state.population / Math.max(1, state.popCapacity);
    const commercialEfficiency = energyRatio * Math.min(1, popRatio * 2); // full at 50% capacity
    const finalIncome = Math.floor(income * commercialEfficiency);

    return { totalEnergy, finalIncome, popCap };
}

function gameTick() {
    if (!state.gameActive) return;

    const stats = calculateStats();
    state.cycle++;

    // Population growth
    if (state.popCapacity > state.population) {
        const growthRate = (state.happiness / 100) * 0.5; // max +0.5 per tick
        const growth = Math.floor(growthRate * (state.popCapacity - state.population) * 0.1);
        if (growth > 0) {
            state.population += growth;
            showToast(`+${growth} Citizens`);
        }
    }

    // Income
    const netIncome = stats.finalIncome;
    state.credits += netIncome;

    if (netIncome > 0) {
        createFloater(document.querySelector('header'), `+${netIncome} Cr`, 'var(--success)');
    }

    // Check failure
    if (state.credits < 0) {
        gameOver("Bankruptcy: Insufficient funding");
    } else if (stats.totalEnergy < 0) {
        gameOver("Blackout: Energy systems failed");
    }

    updateUI();
}

function gameOver(reason) {
    state.gameActive = false;
    clearInterval(state.timer);
    document.getElementById('goMessage').innerText = reason;
    document.getElementById('goPop').innerText = state.population;
    document.getElementById('goCycle').innerText = state.cycle;
    document.getElementById('goHappiness').innerText = state.happiness + '%';
    document.getElementById('gameOverModal').classList.add('open');
    if (tg) tg.HapticFeedback.notificationOccurred('error');
}

function updateUI() {
    const stats = calculateStats();
    document.getElementById('moneyDisplay').innerText = Math.floor(state.credits);
    document.getElementById('energyDisplay').innerText = stats.totalEnergy;
    document.getElementById('energyDisplay').style.color = stats.totalEnergy < 0 ? 'var(--danger)' : '#f87171';
    document.getElementById('popDisplay').innerText = state.population + '/' + state.popCapacity;
    document.getElementById('happyDisplay').innerText = state.happiness + '%';
    document.getElementById('cycleDisplay').innerText = state.cycle;
}

function showToast(msg, type = 'normal') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast' + (type === 'error' ? ' error' : '');
    toast.innerText = msg;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => toast.remove(), 400);
    }, 2500);
}

function createFloater(element, text, color) {
    const rect = element.getBoundingClientRect();
    const floater = document.createElement('div');
    floater.className = 'floater';
    floater.innerText = text;
    floater.style.color = color;
    floater.style.left = (rect.left + rect.width / 2 - 30) + 'px';
    floater.style.top = (rect.top + rect.height / 2) + 'px';
    document.body.appendChild(floater);
    setTimeout(() => floater.remove(), 1200);
}

function shakeUI() {
    const header = document.querySelector('header');
    header.style.animation = 'shake 0.5s ease-in-out';
    setTimeout(() => header.style.animation = '', 500);
}

document.addEventListener('DOMContentLoaded', () => {
    initGrid();
    // Add shake animation
    const style = document.createElement('style');
    style.innerHTML = `@keyframes shake { 0%,100% {transform:translateX(0)} 10%,30%,50%,70%,90% {transform:translateX(-8px)} 20%,40%,60%,80% {transform:translateX(8px)} }`;
    document.head.appendChild(style);
});
</script>
</body>
</html>
