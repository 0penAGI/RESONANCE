<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RIFT: Colony Builder - Reborn</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #050508;
    --panel-bg: rgba(20, 25, 35, 0.85);
    --accent-cyan: #00f3ff;
    --accent-pink: #ff0055;
    --accent-gold: #ffd700;
    --accent-green: #00ff9d;
    --text-main: #e0e6ed;
    --text-dim: #64748b;
    --grid-line: rgba(0, 243, 255, 0.1);
    --cell-size: clamp(35px, 11vmin, 65px);
    --neon-shadow: 0 0 10px rgba(0, 243, 255, 0.3), 0 0 20px rgba(0, 243, 255, 0.1);
    --danger-shadow: 0 0 10px rgba(255, 0, 85, 0.4);
}

/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏ —Å–±—Ä–æ—Å */
* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
body {
    margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main);
    font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; 
    display: flex; flex-direction: column;
    background-image: 
        radial-gradient(circle at 50% 50%, #111927 0%, #050508 100%);
    padding-top: 50px;
}

/* CRT –≠—Ñ—Ñ–µ–∫—Ç (—Å–∫–∞–Ω–∏—Ä—É—é—â–∏–µ –ª–∏–Ω–∏–∏) */
body::after {
    content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 999; pointer-events: none; background-size: 100% 2px, 3px 100%;
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
header {
    background: var(--panel-bg); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--grid-line); padding: 8px 15px;
    z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; gap: 5px;
    position: relative;
    top: 50px;
}
.header-top {
    display: flex; justify-content: space-between; align-items: center;
}
h1 {
    margin: 0; font-family: 'Orbitron', sans-serif; font-size: 1.4rem;
    color: var(--accent-cyan); text-shadow: 0 0 8px var(--accent-cyan);
    letter-spacing: 2px;
}
.header-controls button {
    background: none; border: 1px solid var(--text-dim); color: var(--text-dim);
    padding: 2px 8px; font-family: 'Rajdhani'; font-size: 0.8rem; cursor: pointer;
    border-radius: 4px; transition: 0.2s;
}
.header-controls button:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

.stats-bar {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
}
.stat-item {
    display: flex; flex-direction: column; align-items: center;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
    padding: 4px; border-radius: 4px; position: relative; overflow: hidden;
}
.stat-item::after {
    content: ''; position: absolute; bottom: 0; left: 0; height: 2px;
    width: 100%; background: currentColor; opacity: 0.3;
}
.stat-label { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
.stat-value { 
    font-weight: 700; font-size: 1.1rem; font-family: 'Orbitron', monospace; text-shadow: 0 0 5px currentColor;
}

/* –¶–≤–µ—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ */
.res-credits { color: var(--accent-gold); }
.res-energy { color: var(--accent-cyan); }
.res-pop { color: var(--accent-pink); }
.res-happy { color: var(--accent-green); }

/* –û—Å–Ω–æ–≤–Ω–æ–µ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
main {
    flex: 1; display: flex; justify-content: center; align-items: center;
    overflow: hidden; position: relative; perspective: 1000px;
    margin-top: 50px;
}
.city-grid {
    display: grid;
    grid-template-columns: repeat(8, var(--cell-size));
    grid-template-rows: repeat(8, var(--cell-size));
    gap: 6px; padding: 15px;
    background: rgba(0,0,0,0.3); border: 1px solid var(--grid-line);
    border-radius: 12px; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
    transform-style: preserve-3d;
    transition: transform 0.5s ease;
}

/* –ö–ª–µ—Ç–∫–∏ */
.cell {
    background: rgba(255,255,255,0.02); border: 1px solid var(--grid-line);
    border-radius: 6px; display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    font-size: calc(var(--cell-size) * 0.5); cursor: pointer;
    position: relative; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
.cell:hover { 
    background: rgba(0, 243, 255, 0.1); 
    border-color: var(--accent-cyan); 
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 5px 15px rgba(0, 243, 255, 0.15);
    z-index: 5;
}
.cell .icon { filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); transition: transform 0.3s; }
.cell:hover .icon { transform: scale(1.1); }

/* –¢–∏–ø—ã –∑–¥–∞–Ω–∏–π */
.cell.building-residential { border-color: rgba(240, 100, 100, 0.3); background: linear-gradient(135deg, rgba(240,100,100,0.05), transparent); }
.cell.building-industrial { border-color: rgba(6, 182, 212, 0.3); background: linear-gradient(135deg, rgba(6,182,212,0.05), transparent); }
.cell.building-commercial { border-color: rgba(251, 191, 36, 0.3); background: linear-gradient(135deg, rgba(251,191,36,0.05), transparent); }
.cell.building-park { border-color: rgba(74, 222, 128, 0.3); background: linear-gradient(135deg, rgba(74,222,128,0.05), transparent); }

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–∞ –∫–ª–µ—Ç–∫–∞—Ö */
.cell-indicators {
    position: absolute; bottom: 2px; right: 2px; display: flex; gap: 2px; font-size: 0.6rem;
}

/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–Ω–∏–∑—É */
.controls {
    background: var(--panel-bg); border-top: 1px solid var(--grid-line);
    padding: 10px 15px; z-index: 20;
    backdrop-filter: blur(10px);
}
.tools-scroll {
    display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
    scrollbar-width: none;
}
.tools-scroll::-webkit-scrollbar { display: none; }

.tool-btn {
    background: rgba(0,0,0,0.4); border: 1px solid var(--grid-line);
    border-radius: 8px; padding: 8px 12px; min-width: 85px;
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; transition: all 0.2s; color: var(--text-dim); flex-shrink: 0;
    position: relative; overflow: hidden;
}
.tool-btn:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); }
.tool-btn.selected {
    background: rgba(0, 243, 255, 0.15); border-color: var(--accent-cyan);
    color: var(--accent-cyan); box-shadow: var(--neon-shadow);
}
.tool-icon { font-size: 1.6rem; margin-bottom: 4px; }
.tool-name { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.tool-cost { font-size: 0.7rem; font-family: 'Orbitron'; margin-top: 2px; }

/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center;
    z-index: 100; backdrop-filter: blur(5px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.open { opacity: 1; pointer-events: auto; }
.modal {
    background: rgba(15, 20, 30, 0.95); border: 1px solid var(--accent-cyan);
    padding: 30px; border-radius: 12px; max-width: 90%; width: 400px;
    text-align: center; box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
    transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
}
.modal-overlay.open .modal { transform: scale(1); }
.modal::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
}
.modal h2 { margin-top: 0; font-family: 'Orbitron'; color: var(--accent-cyan); margin-bottom: 20px; }
.modal p { color: var(--text-main); line-height: 1.6; font-size: 1rem; margin: 10px 0; }
.btn-primary {
    background: linear-gradient(90deg, var(--accent-cyan), #00a8ff);
    border: none; padding: 12px 30px; color: #000; font-weight: 800; font-family: 'Orbitron';
    border-radius: 4px; cursor: pointer; margin-top: 25px; width: 100%;
    text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
    clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }
.btn-primary:active { transform: translateY(1px); }

/* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Toast) */
.toast-container {
    position: fixed; top: 80px; right: 20px; left: 20px;
    display: flex; flex-direction: column; gap: 10px; z-index: 50; pointer-events: none;
}
.toast {
    background: rgba(0, 0, 0, 0.9); border-left: 4px solid var(--accent-cyan);
    color: white; padding: 12px 20px; border-radius: 4px; font-size: 0.9rem;
    animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-between;
}
.toast.error { border-left-color: var(--accent-pink); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç –Ω–∞–¥ –∫–ª–µ—Ç–∫–∞–º–∏ */
.floater {
    position: absolute; font-weight: bold; font-size: 0.9rem; pointer-events: none;
    animation: floatUpFade 1.2s forwards; z-index: 30; text-shadow: 0 0 2px black;
    font-family: 'Orbitron';
}
@keyframes floatUpFade {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-30px); opacity: 0; }
}

/* –¢—É–ª—Ç–∏–ø (–ø–æ–¥—Å–∫–∞–∑–∫–∞) */
#tooltip {
    position: absolute; background: rgba(10, 10, 15, 0.95); border: 1px solid var(--text-dim);
    color: #fff; padding: 8px 12px; border-radius: 4px; font-size: 0.8rem;
    pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 100;
    max-width: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.8);
}
#tooltip strong { color: var(--accent-cyan); display: block; margin-bottom: 4px; }

/* –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏ */
.shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* –§–æ–Ω–æ–≤—ã–µ —á–∞—Å—Ç–∏—Ü—ã (–∑–≤–µ–∑–¥—ã) canvas */
#bgCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0.5; }

</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<!-- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –æ–∫–Ω–æ -->
<div id="startModal" class="modal-overlay open">
    <div class="modal">
        <h2>RIFT PROTOCOL</h2>
        <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∏–∏ –≤ –∏–∑–º–µ—Ä–µ–Ω–∏–∏ RIFT.</p>
        <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; font-size: 0.9rem; margin: 15px 0;">
            <div style="margin-bottom: 8px"><span style="color:var(--accent-pink)">üè† Hab-Dome</span> ‚Äî –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –Ω–∞—Å–µ–ª–µ–Ω–∏—è</div>
            <div style="margin-bottom: 8px"><span style="color:var(--accent-cyan)">‚ö° Reactor</span> ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —ç–Ω–µ—Ä–≥–∏—é</div>
            <div style="margin-bottom: 8px"><span style="color:var(--accent-gold)">üè¢ Trade Hub</span> ‚Äî –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ —Å –Ω–∞—Å–µ–ª–µ–Ω–∏—è</div>
            <div><span style="color:var(--accent-green)">üå≥ Bio-Dome</span> ‚Äî –ü–æ–≤—ã—à–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ –∏ —Ä–æ—Å—Ç</div>
        </div>
        <p style="color: var(--accent-pink); font-size: 0.85rem">‚ö†Ô∏è –°–ª–µ–¥–∏—Ç–µ –∑–∞ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–º –±–∞–ª–∞–Ω—Å–æ–º.</p>
        <button class="btn-primary" onclick="startGame()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
    </div>
</div>

<!-- Game Over –æ–∫–Ω–æ -->
<div id="gameOverModal" class="modal-overlay">
    <div class="modal">
        <h2 id="goTitle" style="color: var(--accent-pink)">–°–ë–û–ô –°–ò–°–¢–ï–ú–´</h2>
        <p id="goMessage">–ö–æ–ª–æ–Ω–∏—è –ø–æ–≥–∏–±–ª–∞.</p>
        <div style="margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left;">
            <div>–ù–∞—Å–µ–ª–µ–Ω–∏–µ:</div><div id="goPop" style="text-align: right; font-weight:bold; color:var(--accent-pink)">0</div>
            <div>–¶–∏–∫–ª–æ–≤:</div><div id="goCycle" style="text-align: right; font-weight:bold">0</div>
            <div>–°—á–∞—Å—Ç—å–µ:</div><div id="goHappiness" style="text-align: right; font-weight:bold; color:var(--accent-green)">0%</div>
        </div>
        <button class="btn-primary" onclick="resetGame()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞</button>
    </div>
</div>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
<div id="tooltip"></div>

<header>
    <div class="header-top">
        <h1>RIFT</h1>
        <div class="header-controls">
            <span style="color:var(--accent-cyan); font-family:'Orbitron'; font-size: 0.9rem; margin-right: 10px;">CYC: <span id="cycleDisplay">0</span></span>
            <button onclick="clearSave()">–°–±—Ä–æ—Å</button>
        </div>
    </div>
    <div class="stats-bar">
        <div class="stat-item res-credits">
            <span class="stat-label">–ö—Ä–µ–¥–∏—Ç—ã</span>
            <span class="stat-value" id="moneyDisplay">0</span>
        </div>
        <div class="stat-item res-energy">
            <span class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</span>
            <span class="stat-value" id="energyDisplay">0</span>
        </div>
        <div class="stat-item res-pop">
            <span class="stat-label">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</span>
            <span class="stat-value" id="popDisplay">0</span>
        </div>
        <div class="stat-item res-happy">
            <span class="stat-label">–°—á–∞—Å—Ç—å–µ</span>
            <span class="stat-value" id="happyDisplay">0%</span>
        </div>
    </div>
</header>

<main>
    <div id="grid" class="city-grid"></div>
</main>

<div class="controls">
    <div class="tools-scroll">
        <div class="tool-btn" data-tool="bulldoze" onclick="selectTool('bulldoze')">
            <div class="tool-icon">üöß</div>
            <div class="tool-name">–û—á–∏—Å—Ç–∏—Ç—å</div>
            <div class="tool-cost" style="color: var(--accent-green)">+5 CR</div>
        </div>
        <div class="tool-btn selected" data-tool="residential" onclick="selectTool('residential')">
            <div class="tool-icon">üè†</div>
            <div class="tool-name">Hab-Dome</div>
            <div class="tool-cost">50 CR</div>
        </div>
        <div class="tool-btn" data-tool="industrial" onclick="selectTool('industrial')">
            <div class="tool-icon">‚ö°</div>
            <div class="tool-name">Reactor</div>
            <div class="tool-cost">100 CR</div>
        </div>
        <div class="tool-btn" data-tool="commercial" onclick="selectTool('commercial')">
            <div class="tool-icon">üè¢</div>
            <div class="tool-name">Trade Hub</div>
            <div class="tool-cost">150 CR</div>
        </div>
        <div class="tool-btn" data-tool="park" onclick="selectTool('park')">
            <div class="tool-icon">üå≥</div>
            <div class="tool-name">Bio-Dome</div>
            <div class="tool-cost">75 CR</div>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<script>
// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ò–≥—Ä—ã ---
const GRID_SIZE = 8;
const TICK_RATE = 2000; // –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–º—Å)
const SAVE_KEY = 'rift_colony_save_v2';

// –î–∞–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏–π
const BUILDINGS = {
    residential: { 
        name: 'Hab-Dome', icon: 'üè†', cost: 50, energy: -2, popCap: 10, incomeMod: 0, happiness: 0,
        desc: '–ñ–∏–ª–∏—â–Ω—ã–π –º–æ–¥—É–ª—å. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–µ—Å—Ç–æ –¥–ª—è 10 –∫–æ–ª–æ–Ω–∏—Å—Ç–æ–≤.'
    },
    industrial:  { 
        name: 'Reactor', icon: '‚ö°', cost: 100, energy: 20, popCap: 0, incomeMod: 0, happiness: -5,
        desc: '–Ø–¥–µ—Ä–Ω—ã–π —Ä–µ–∞–∫—Ç–æ—Ä. –í—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 20 –µ–¥. —ç–Ω–µ—Ä–≥–∏–∏. –í—Ä–µ–¥–µ–Ω –¥–ª—è —ç–∫–æ–ª–æ–≥–∏–∏.'
    },
    commercial:  { 
        name: 'Trade Hub', icon: 'üè¢', cost: 150, energy: -3, popCap: 0, incomeMod: 1.5, happiness: 2,
        desc: '–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –Ω–∞–ª–æ–≥–∏ —Å –Ω–∞—Å–µ–ª–µ–Ω–∏—è –Ω–∞ 50%. –¢—Ä–µ–±—É–µ—Ç —ç–Ω–µ—Ä–≥–∏—é.'
    },
    park:        { 
        name: 'Bio-Dome', icon: 'üå≥', cost: 75, energy: -1, popCap: 0, incomeMod: 0, happiness: 15,
        desc: '–≠–∫–æ—Å—Ñ–µ—Ä–∞. –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–æ—Å—Ç–∞.'
    },
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
let state = {
    credits: 200, // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª —É–≤–µ–ª–∏—á–µ–Ω
    energy: 15,
    population: 2,
    popCapacity: 0,
    happiness: 50, 
    cycle: 0,
    grid: [], // 8x8 array
    selectedTool: 'residential',
    gameActive: false,
    timer: null
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å)
const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.ready(); }

// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–æ–π (–§–æ–Ω) ---
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function initParticles() {
    particles = [];
    for(let i=0; i<50; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2,
            speed: Math.random() * 0.5 + 0.1,
            opacity: Math.random()
        });
    }
}

function animateBg() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#ffffff';
    particles.forEach(p => {
        p.y -= p.speed;
        if(p.y < 0) p.y = canvas.height;
        ctx.globalAlpha = p.opacity * 0.5;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
    });
    requestAnimationFrame(animateBg);
}
initParticles();
animateBg();


// --- –û—Å–Ω–æ–≤–Ω–∞—è –õ–æ–≥–∏–∫–∞ ---

function initGrid() {
    const gridEl = document.getElementById('grid');
    gridEl.innerHTML = '';
    state.grid = [];
    for (let y = 0; y < GRID_SIZE; y++) {
        const row = [];
        for (let x = 0; x < GRID_SIZE; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.x = x;
            cell.dataset.y = y;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
            cell.onclick = () => handleCellClick(x, y, cell);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (Hover)
            cell.onmouseenter = (e) => showTooltip(e, state.grid[y][x], x, y);
            cell.onmouseleave = () => hideTooltip();
            // –î–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤
            cell.ontouchstart = (e) => showTooltip(e.touches[0], state.grid[y][x], x, y);

            gridEl.appendChild(cell);
            row.push(null);
        }
        state.grid.push(row);
    }
}

function calculateStats() {
    let energyProd = 15; // –ë–∞–∑–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è
    let energyUse = 0;
    let popCap = 0;
    let happyMod = 0;
    let incomeMultiplier = 1.0; // –ë–∞–∑–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–æ—Ö–æ–¥–∞

    // –°—á–∏—Ç–∞–µ–º –∑–¥–∞–Ω–∏—è
    for (let row of state.grid) {
        for (let type of row) {
            if (type) {
                const b = BUILDINGS[type];
                popCap += b.popCap;
                happyMod += b.happiness;
                incomeMultiplier += b.incomeMod; // –¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã –¥–∞—é—Ç % –∫ –Ω–∞–ª–æ–≥–∞–º
                
                if (b.energy > 0) energyProd += b.energy;
                else if (b.energy < 0) energyUse += Math.abs(b.energy);
            }
        }
    }

    state.popCapacity = popCap;
    state.energy = energyProd - energyUse;

    // –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏ (—Å—á–∞—Å—Ç—å–µ –ø–∞–¥–∞–µ—Ç, –µ—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–µ—Ç)
    if (state.energy < 0) {
        happyMod -= 5; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à—Ç—Ä–∞—Ñ
    }

    // –†–∞—Å—á–µ—Ç —Å—á–∞—Å—Ç—å—è (0-100)
    state.happiness = Math.max(0, Math.min(100, 50 + happyMod));

    return { 
        totalEnergy: state.energy, 
        incomeMultiplier: incomeMultiplier,
        energyRatio: state.energy >= 0 ? 1 : 0.5 // –ï—Å–ª–∏ –Ω–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç
    };
}

function gameTick() {
    if (!state.gameActive) return;

    const stats = calculateStats();
    state.cycle++;

    // 1. –†–æ—Å—Ç –Ω–∞—Å–µ–ª–µ–Ω–∏—è
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –∏ —Å—á–∞—Å—Ç—å–µ > 30%
    if (state.popCapacity > state.population && state.happiness > 30) {
        // –§–æ—Ä–º—É–ª–∞ —Ä–æ—Å—Ç–∞: —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ—Å—Ç–∞ * (—Å—á–∞—Å—Ç—å–µ/100) * —à–∞–Ω—Å
        const growthChance = (state.happiness / 100); 
        const growthPotential = (state.popCapacity - state.population);
        
        // –†–æ—Å—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ –∫–∞–∂–¥—ã–π —Ç–∏–∫, –∞ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
        if (Math.random() < growthChance || growthPotential > 20) {
             const growth = Math.ceil(growthPotential * 0.1 * growthChance); // –î–æ 10% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∑–∞ —Ä–∞–∑
             if (growth > 0) {
                 state.population = Math.min(state.popCapacity, state.population + growth);
                 showToast(`+${growth} –ö–æ–ª–æ–Ω–∏—Å—Ç—ã`, 'info');
             }
        }
    } else if (state.happiness < 20 && state.population > 0) {
        // –ë–µ–≥—É—Ç –µ—Å–ª–∏ –Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ
        if (Math.random() < 0.3) {
            state.population--;
            showToast(`–ö–æ–ª–æ–Ω–∏—Å—Ç —É—à–µ–ª!`, 'error');
        }
    }

    // 2. –î–æ—Ö–æ–¥ (–ù–∞–ª–æ–≥–∏)
    // –ë–∞–∑–æ–≤—ã–π –Ω–∞–ª–æ–≥ —Å 1 —á–µ–ª–æ–≤–µ–∫–∞ = 2 –∫—Ä–µ–¥–∏—Ç–∞. * –Ω–∞ –º–Ω–æ–∂–∏—Ç–µ–ª—å –∑–¥–∞–Ω–∏–π
    const baseTax = state.population * 2; 
    const income = Math.floor(baseTax * stats.incomeMultiplier * stats.energyRatio);
    
    state.credits += income;

    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Ö–æ–¥–∞/—Ä–∞—Å—Ö–æ–¥–∞
    if (income !== 0) {
        const sign = income >= 0 ? '+' : '';
        const color = income >= 0 ? 'var(--accent-gold)' : 'var(--accent-pink)';
        createFloater(document.getElementById('moneyDisplay'), `${sign}${income} CR`, color);
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
    if (state.credits < -50) { // –î–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –≤ –¥–æ–ª–≥
        gameOver("–ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ: –ö–æ–ª–æ–Ω–∏—é –ø—Ä–æ–¥–∞–ª–∏ –∑–∞ –¥–æ–ª–≥–∏.");
    } 
    // –≠–Ω–µ—Ä–≥–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç Game Over —Å—Ä–∞–∑—É, –Ω–æ —É–±–∏–≤–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ –∏ –¥–æ—Ö–æ–¥.

    updateUI();
    saveGame();
}

function handleCellClick(x, y, cellEl) {
    if (!state.gameActive) return;

    const current = state.grid[y][x];
    const tool = state.selectedTool;

    // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–°–Ω–æ—Å"
    if (tool === 'bulldoze') {
        if (current) {
            state.credits += 5; 
            state.grid[y][x] = null;
            renderCell(x, y, null);
            createFloater(cellEl, '+5 CR', 'var(--accent-green)');
            updateUI();
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }
        return;
    }

    // –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ
    if (current) {
        showToast("–ó–∞–Ω—è—Ç–æ! –û—á–∏—Å—Ç–∏—Ç–µ —è—á–µ–π–∫—É.", "error");
        return;
    }

    const b = BUILDINGS[tool];
    if (state.credits >= b.cost) {
        state.credits -= b.cost;
        state.grid[y][x] = tool;
        
        renderCell(x, y, tool);
        createFloater(cellEl, `-${b.cost} CR`, 'var(--text-main)');
        
        calculateStats(); // –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ä–∞–∑—É –¥–ª—è UI
        updateUI();
        saveGame();
        
        if (tg) tg.HapticFeedback.impactOccurred('medium');
    } else {
        showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤!", "error");
        shakeUI(document.querySelector('.controls'));
    }
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–ª–µ—Ç–∫–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
function renderCell(x, y, type) {
    // –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –≤ DOM
    const index = y * GRID_SIZE + x;
    const cell = document.getElementById('grid').children[index];
    
    if (!type) {
        cell.innerHTML = '';
        cell.className = 'cell';
        return;
    }

    const b = BUILDINGS[type];
    cell.className = `cell building-${type}`;
    
    // –°–æ–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    let indicators = '';
    if (b.energy !== 0) {
        indicators += `<span style="color:${b.energy>0 ? 'var(--accent-cyan)':'var(--accent-pink)'}">${b.energy>0 ? '+':'-'}${Math.abs(b.energy)}‚ö°</span>`;
    }
    if (b.popCap > 0) {
        indicators += `<span style="color:var(--accent-pink)">+${b.popCap}üë§</span>`;
    }

    cell.innerHTML = `
        <div class="icon">${b.icon}</div>
        <div class="cell-indicators">${indicators}</div>
    `;
}

// --- UI –§—É–Ω–∫—Ü–∏–∏ ---

function updateUI() {
    const stats = calculateStats();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–µ–ª (–ø—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞)
    document.getElementById('moneyDisplay').innerText = Math.floor(state.credits);
    document.getElementById('energyDisplay').innerText = stats.totalEnergy;
    
    // –¶–≤–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏
    const eEl = document.getElementById('energyDisplay');
    if (stats.totalEnergy < 0) eEl.style.color = 'var(--accent-pink)';
    else eEl.style.color = 'var(--accent-cyan)';

    document.getElementById('popDisplay').innerText = `${state.population}/${state.popCapacity}`;
    document.getElementById('happyDisplay').innerText = state.happiness + '%';
    document.getElementById('cycleDisplay').innerText = state.cycle;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫ (–∞–∫—Ç–∏–≤–Ω—ã –ª–∏)
    document.querySelectorAll('.tool-btn').forEach(btn => {
        const tool = btn.dataset.tool;
        if (tool !== 'bulldoze') {
            const cost = BUILDINGS[tool].cost;
            if (state.credits < cost) {
                btn.style.opacity = '0.5';
            } else {
                btn.style.opacity = '1';
            }
        }
    });
}

function selectTool(tool) {
    state.selectedTool = tool;
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.tool === tool);
    });
}

function showToast(msg, type = 'normal') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';
    if (type === 'error') toast.classList.add('error');
    if (type === 'info') toast.style.borderLeftColor = 'var(--accent-gold)';
    
    toast.innerHTML = `<span>${msg}</span>`;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function createFloater(element, text, color) {
    const rect = element.getBoundingClientRect();
    const floater = document.createElement('div');
    floater.className = 'floater';
    floater.innerText = text;
    floater.style.color = color;
    floater.style.left = (rect.left + rect.width / 2 - 20) + 'px';
    floater.style.top = (rect.top) + 'px';
    document.body.appendChild(floater);
    setTimeout(() => floater.remove(), 1200);
}

function shakeUI(element) {
    element.classList.remove('shake');
    void element.offsetWidth; // trigger reflow
    element.classList.add('shake');
}

// –¢—É–ª—Ç–∏–ø—ã
function showTooltip(e, type, x, y) {
    const tooltip = document.getElementById('tooltip');
    let content = '';
    
    if (type) {
        const b = BUILDINGS[type];
        content = `<strong>${b.name}</strong>${b.desc}`;
    } else {
        content = `<strong>–ü—É—Å—Ç–æ–π —Å–µ–∫—Ç–æ—Ä</strong>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–æ–∏—Ç—å.`;
    }
    
    tooltip.innerHTML = content;
    tooltip.style.opacity = 1;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    const xVal = e.clientX || e.pageX;
    const yVal = e.clientY || e.pageY;
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–ª–µ—Ç–∞ –∑–∞ —ç–∫—Ä–∞–Ω
    let left = xVal + 15;
    let top = yVal + 15;
    
    if (left + 200 > window.innerWidth) left = xVal - 215;
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
}

function hideTooltip() {
    const tooltip = document.getElementById('tooltip');
    tooltip.style.opacity = 0;
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ó–∞–≥—Ä—É–∑–∫–∞ ---

function saveGame() {
    if (!state.gameActive) return;
    const saveString = JSON.stringify(state);
    localStorage.setItem(SAVE_KEY, saveString);
}

function loadGame() {
    const saveString = localStorage.getItem(SAVE_KEY);
    if (saveString) {
        try {
            const loadedState = JSON.parse(saveString);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
            state.credits = loadedState.credits;
            state.grid = loadedState.grid;
            state.cycle = loadedState.cycle;
            state.population = loadedState.population;
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ —Å—Ç–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            calculateStats();
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    renderCell(x, y, state.grid[y][x]);
                }
            }
            return true;
        } catch (e) {
            console.error("Save corrupted", e);
            return false;
        }
    }
    return false;
}

function clearSave() {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
}

// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–æ–π ---

function startGame() {
    document.getElementById('startModal').classList.remove('open');
    
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å
    const hasSave = loadGame();
    
    if (!hasSave) {
        initGrid();
    } else {
        // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏, –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ UI —á–∏—Å—Ç
        const gridEl = document.getElementById('grid');
        if(gridEl.children.length === 0) initGrid(); 
    }

    updateUI();
    state.gameActive = true;
    state.timer = setInterval(gameTick, TICK_RATE);
    
    if (!hasSave) showToast("–ö–æ–ª–æ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.", "info");
    else showToast("–°–∏—Å—Ç–µ–º—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –∞—Ä—Ö–∏–≤–∞.", "info");
    
    if (tg) tg.HapticFeedback.impactOccurred('light');
}

function resetGame() {
    if (state.timer) clearInterval(state.timer);
    document.getElementById('gameOverModal').classList.remove('open');
    localStorage.removeItem(SAVE_KEY); // –£–¥–∞–ª—è–µ–º —Å–µ–π–≤ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
    
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state.credits = 200;
    state.energy = 15;
    state.population = 2;
    state.popCapacity = 0;
    state.happiness = 50;
    state.cycle = 0;
    state.grid = [];
    
    startGame();
}

function gameOver(reason) {
    state.gameActive = false;
    clearInterval(state.timer);
    document.getElementById('goMessage').innerText = reason;
    document.getElementById('goPop').innerText = state.population;
    document.getElementById('goCycle').innerText = state.cycle;
    document.getElementById('goHappiness').innerText = state.happiness + '%';
    document.getElementById('gameOverModal').classList.add('open');
    localStorage.removeItem(SAVE_KEY); // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ
    if (tg) tg.HapticFeedback.notificationOccurred('error');
}

// –°—Ç–∞—Ä—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–µ–π–≤, –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "Continue", –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º –∫–ª–∏–∫–∞ "Initialize"
});

</script>
</body>
</html>
